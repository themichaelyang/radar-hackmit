'use strict';

var debug = false;
var canvas = void 0;
var context = void 0;
var pos = [0, 0];
// let xpixels = 480;
// let ypixels = 270;

var xpixels = 360;
var ypixels = 200;

// let xpixels = 240;
// let ypixels = 135;


function getVideo() {

  canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  canvas.width = xpixels;
  canvas.height = ypixels;
  context = canvas.getContext('2d');

  // consider setting the video constraints in the individual video media track within the stream
  var video = document.createElement('video');
  var userMediaConstraints = {
    video: { width: { exact: xpixels }, height: { exact: ypixels }, facingMode: 'user' }, // set a framerate constraint?
    audio: false
  };

  navigator.mediaDevices.getUserMedia(userMediaConstraints).then(onGetUserMediaSuccess).catch(onGetUserMediaError);

  function onGetUserMediaSuccess(mediaStream) {
    video.src = window.URL.createObjectURL(mediaStream);
    video.play();
  }

  function onGetUserMediaError(error) {
    console.error(error);
  }

  document.body.appendChild(video);
  return video; // watch out! metadata doesnt load initially! its async
}

function getVideoFrame(video) {
  var canvas = document.createElement('canvas'); // consider reading raw img data from videos
  var ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return ctx;
}

function getPixelDistance(one, two, i) {
  var rdiff = one.data[i] - two.data[i];
  var gdiff = one.data[i + 1] - two.data[i + 1];
  var bdiff = one.data[i + 2] - two.data[i + 2];

  var dist = Math.floor(Math.sqrt(Math.pow(rdiff, 2) + Math.pow(gdiff, 2) + Math.pow(bdiff, 2)));
  return dist / 441;
}

function compare(currentFrame, previousFrame) {
  var changedIndexes = [];
  var currentFrameImageData = currentFrame.getImageData(0, 0, xpixels, ypixels);
  var lastFrameImageData = previousFrame.getImageData(0, 0, xpixels, ypixels);
  var processedImageData = currentFrame.createImageData(currentFrameImageData);

  for (var i = 0; i < currentFrameImageData.data.length; i += 4) {
    // canvas image data is ordered "r, g, b, a" in a clamped byte array
    // processedImageData = processedImageData.data[i, i + 3]
    if (getPixelDistance(currentFrameImageData, lastFrameImageData, i) > 0.15) {
      var index = i / 4;
      changedIndexes.push(index);

      processedImageData.data[i] = 0;
      processedImageData.data[i + 1] = 0;
      processedImageData.data[i + 2] = 0;
      processedImageData.data[i + 3] = 255;
    }
  }
  context.putImageData(processedImageData, 0, 0);

  var changedxy = changedIndexes.map(function (x) {
    return indexToCoordinates(x, xpixels);
  });

  var changes = changedxy.length;
  var sumx = 0;
  var sumy = 0;
  // let
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = changedxy[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var pixel = _step.value;

      sumx += pixel.x;
      sumy += pixel.y;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return [changes, sumx / changes, sumy / changes];
  console.log(change, sumx / changes, sumy / changes);

  // context.putImageData(processedImageData, 0, 0);
}

function indexToCoordinates(index, width) {
  // remember that the index is r g b a!!! fix this function
  var y = Math.floor(index / width);
  var x = index - y * width;
  return {
    x: x,
    y: y
  };
}

function Radar() {
  var fps = 30;
  var radar = new Object();
  // let comparer = new ImageCompare();
  var previousFrame = void 0;

  radar.start = function () {
    radar.video = getVideo(); // change to promise interface?
  };

  radar.startLoop = function () {
    window.requestAnimationFrame(function () {
      loop();
    });
  };

  function loop() {
    // we should pass in time differences?
    var currentFrame = getVideoFrame(radar.video);
    process(currentFrame, previousFrame);

    previousFrame = currentFrame;

    window.setTimeout(function () {
      window.requestAnimationFrame(function () {
        loop();
      });
    }, 1000 / fps);
  }

  function process(currentFrame, previousFrame) {
    if (previousFrame) {
      var xy = compare(currentFrame, previousFrame, xpixels, ypixels);

      if (xy[0] > 50) {
        pos[0] = xy[1];
        pos[1] = xy[2];
        //   pos[0] = xy[1] / ypixels
        //   pos[1] = xy[2] / xpixels
      }
      // context.putImageData(processedImageData, pos[0], pos[1]);
      // console.log(pos);
      context.fillStyle = 'red';
      context.fillRect(pos[0], pos[1], 20, 20);
      //   console.log(xy);
    }
  }

  return radar;
}

// why isn't this separated into files?!??!
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZyYW1lLWRpZmZlcmVuY2UuanMiXSwibmFtZXMiOlsiZGVidWciLCJjYW52YXMiLCJjb250ZXh0IiwicG9zIiwieHBpeGVscyIsInlwaXhlbHMiLCJnZXRWaWRlbyIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsInZpZGVvIiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJleGFjdCIsImZhY2luZ01vZGUiLCJhdWRpbyIsIm5hdmlnYXRvciIsIm1lZGlhRGV2aWNlcyIsImdldFVzZXJNZWRpYSIsInRoZW4iLCJvbkdldFVzZXJNZWRpYVN1Y2Nlc3MiLCJjYXRjaCIsIm9uR2V0VXNlck1lZGlhRXJyb3IiLCJtZWRpYVN0cmVhbSIsInNyYyIsIndpbmRvdyIsIlVSTCIsImNyZWF0ZU9iamVjdFVSTCIsInBsYXkiLCJlcnJvciIsImNvbnNvbGUiLCJnZXRWaWRlb0ZyYW1lIiwiY3R4IiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwiZHJhd0ltYWdlIiwiZ2V0UGl4ZWxEaXN0YW5jZSIsIm9uZSIsInR3byIsImkiLCJyZGlmZiIsImRhdGEiLCJnZGlmZiIsImJkaWZmIiwiZGlzdCIsIk1hdGgiLCJmbG9vciIsInNxcnQiLCJwb3ciLCJjb21wYXJlIiwiY3VycmVudEZyYW1lIiwicHJldmlvdXNGcmFtZSIsImNoYW5nZWRJbmRleGVzIiwiY3VycmVudEZyYW1lSW1hZ2VEYXRhIiwiZ2V0SW1hZ2VEYXRhIiwibGFzdEZyYW1lSW1hZ2VEYXRhIiwicHJvY2Vzc2VkSW1hZ2VEYXRhIiwiY3JlYXRlSW1hZ2VEYXRhIiwibGVuZ3RoIiwiaW5kZXgiLCJwdXNoIiwicHV0SW1hZ2VEYXRhIiwiY2hhbmdlZHh5IiwibWFwIiwieCIsImluZGV4VG9Db29yZGluYXRlcyIsImNoYW5nZXMiLCJzdW14Iiwic3VteSIsInBpeGVsIiwieSIsImxvZyIsImNoYW5nZSIsIlJhZGFyIiwiZnBzIiwicmFkYXIiLCJPYmplY3QiLCJzdGFydCIsInN0YXJ0TG9vcCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImxvb3AiLCJwcm9jZXNzIiwic2V0VGltZW91dCIsInh5IiwiZmlsbFN0eWxlIiwiZmlsbFJlY3QiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLFFBQVEsS0FBWjtBQUNBLElBQUlDLGVBQUo7QUFDQSxJQUFJQyxnQkFBSjtBQUNBLElBQUlDLE1BQU0sQ0FBQyxDQUFELEVBQUksQ0FBSixDQUFWO0FBQ0E7QUFDQTs7QUFFQSxJQUFJQyxVQUFVLEdBQWQ7QUFDQSxJQUFJQyxVQUFVLEdBQWQ7O0FBRUE7QUFDQTs7O0FBR0EsU0FBU0MsUUFBVCxHQUFvQjs7QUFFaEJMLFdBQVNNLFNBQVNDLGFBQVQsQ0FBdUIsUUFBdkIsQ0FBVDtBQUNBRCxXQUFTRSxJQUFULENBQWNDLFdBQWQsQ0FBMEJULE1BQTFCO0FBQ0FBLFNBQU9VLEtBQVAsR0FBZVAsT0FBZjtBQUNBSCxTQUFPVyxNQUFQLEdBQWdCUCxPQUFoQjtBQUNBSCxZQUFVRCxPQUFPWSxVQUFQLENBQWtCLElBQWxCLENBQVY7O0FBRUY7QUFDQSxNQUFJQyxRQUFRUCxTQUFTQyxhQUFULENBQXVCLE9BQXZCLENBQVo7QUFDQSxNQUFJTyx1QkFBdUI7QUFDekJELFdBQU8sRUFBRUgsT0FBTyxFQUFDSyxPQUFPWixPQUFSLEVBQVQsRUFBMkJRLFFBQVEsRUFBQ0ksT0FBT1gsT0FBUixFQUFuQyxFQUFxRFksWUFBWSxNQUFqRSxFQURrQixFQUN5RDtBQUNsRkMsV0FBTztBQUZrQixHQUEzQjs7QUFLQUMsWUFBVUMsWUFBVixDQUF1QkMsWUFBdkIsQ0FBb0NOLG9CQUFwQyxFQUN1Qk8sSUFEdkIsQ0FDNEJDLHFCQUQ1QixFQUV1QkMsS0FGdkIsQ0FFNkJDLG1CQUY3Qjs7QUFJQSxXQUFTRixxQkFBVCxDQUErQkcsV0FBL0IsRUFBNEM7QUFDMUNaLFVBQU1hLEdBQU4sR0FBWUMsT0FBT0MsR0FBUCxDQUFXQyxlQUFYLENBQTJCSixX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IGRlYnVnID0gZmFsc2U7XG5sZXQgY2FudmFzO1xubGV0IGNvbnRleHQ7XG5sZXQgcG9zID0gWzAsIDBdO1xuLy8gbGV0IHhwaXhlbHMgPSA0ODA7XG4vLyBsZXQgeXBpeGVscyA9IDI3MDtcblxubGV0IHhwaXhlbHMgPSAzNjA7XG5sZXQgeXBpeGVscyA9IDIwMDtcblxuLy8gbGV0IHhwaXhlbHMgPSAyNDA7XG4vLyBsZXQgeXBpeGVscyA9IDEzNTtcblxuXG5mdW5jdGlvbiBnZXRWaWRlbygpIHtcblxuICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcbiAgICBjYW52YXMud2lkdGggPSB4cGl4ZWxzO1xuICAgIGNhbnZhcy5oZWlnaHQgPSB5cGl4ZWxzO1xuICAgIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKVxuXG4gIC8vIGNvbnNpZGVyIHNldHRpbmcgdGhlIHZpZGVvIGNvbnN0cmFpbnRzIGluIHRoZSBpbmRpdmlkdWFsIHZpZGVvIG1lZGlhIHRyYWNrIHdpdGhpbiB0aGUgc3RyZWFtXG4gIGxldCB2aWRlbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ZpZGVvJyk7XG4gIGxldCB1c2VyTWVkaWFDb25zdHJhaW50cyA9IHtcbiAgICB2aWRlbzogeyB3aWR0aDoge2V4YWN0OiB4cGl4ZWxzfSwgaGVpZ2h0OiB7ZXhhY3Q6IHlwaXhlbHN9LCBmYWNpbmdNb2RlOiAndXNlcicgfSwgLy8gc2V0IGEgZnJhbWVyYXRlIGNvbnN0cmFpbnQ/XG4gICAgYXVkaW86IGZhbHNlXG4gIH07XG5cbiAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEodXNlck1lZGlhQ29uc3RyYWludHMpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihvbkdldFVzZXJNZWRpYVN1Y2Nlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2gob25HZXRVc2VyTWVkaWFFcnJvcik7XG5cbiAgZnVuY3Rpb24gb25HZXRVc2VyTWVkaWFTdWNjZXNzKG1lZGlhU3RyZWFtKSB7XG4gICAgdmlkZW8uc3JjID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobWVkaWFTdHJlYW0pO1xuICAgIHZpZGVvLnBsYXkoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uR2V0VXNlck1lZGlhRXJyb3IoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxuXG4gIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodmlkZW8pO1xuICByZXR1cm4gdmlkZW87IC8vIHdhdGNoIG91dCEgbWV0YWRhdGEgZG9lc250IGxvYWQgaW5pdGlhbGx5ISBpdHMgYXN5bmNcbn1cblxuZnVuY3Rpb24gZ2V0VmlkZW9GcmFtZSh2aWRlbykge1xuICBsZXQgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7IC8vIGNvbnNpZGVyIHJlYWRpbmcgcmF3IGltZyBkYXRhIGZyb20gdmlkZW9zXG4gIGxldCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgY2FudmFzLndpZHRoID0gdmlkZW8udmlkZW9XaWR0aDtcbiAgY2FudmFzLmhlaWdodCA9IHZpZGVvLnZpZGVvSGVpZ2h0O1xuICBjdHguZHJhd0ltYWdlKHZpZGVvLCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpXG4gIHJldHVybiBjdHg7XG59XG5cbmZ1bmN0aW9uIGdldFBpeGVsRGlzdGFuY2Uob25lLCB0d28sIGkpIHtcbiAgICB2YXIgcmRpZmYgPSBvbmUuZGF0YVtpXSAtIHR3by5kYXRhW2ldO1xuICAgIHZhciBnZGlmZiA9IG9uZS5kYXRhW2kgKyAxXSAtIHR3by5kYXRhW2kgKyAxXTtcbiAgICB2YXIgYmRpZmYgPSBvbmUuZGF0YVtpICsgMl0gLSB0d28uZGF0YVtpICsgMl07XG5cbiAgICB2YXIgZGlzdCA9IE1hdGguZmxvb3IoTWF0aC5zcXJ0KE1hdGgucG93KHJkaWZmLCAyKSArIE1hdGgucG93KGdkaWZmLCAyKSArIE1hdGgucG93KGJkaWZmLCAyKSkpO1xuICAgIHJldHVybiBkaXN0IC8gNDQxO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSkge1xuICAgIGxldCBjaGFuZ2VkSW5kZXhlcyA9IFtdXG4gICAgbGV0IGN1cnJlbnRGcmFtZUltYWdlRGF0YSA9IGN1cnJlbnRGcmFtZS5nZXRJbWFnZURhdGEoMCwgMCwgeHBpeGVscywgeXBpeGVscyk7XG4gICAgbGV0IGxhc3RGcmFtZUltYWdlRGF0YSA9IHByZXZpb3VzRnJhbWUuZ2V0SW1hZ2VEYXRhKDAsIDAsIHhwaXhlbHMsIHlwaXhlbHMpO1xuXHQgIGxldCBwcm9jZXNzZWRJbWFnZURhdGEgPSBjdXJyZW50RnJhbWUuY3JlYXRlSW1hZ2VEYXRhKGN1cnJlbnRGcmFtZUltYWdlRGF0YSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnJlbnRGcmFtZUltYWdlRGF0YS5kYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICAgIC8vIGNhbnZhcyBpbWFnZSBkYXRhIGlzIG9yZGVyZWQgXCJyLCBnLCBiLCBhXCIgaW4gYSBjbGFtcGVkIGJ5dGUgYXJyYXlcbiAgICAgICAgLy8gcHJvY2Vzc2VkSW1hZ2VEYXRhID0gcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaSwgaSArIDNdXG4gICAgICAgIGlmIChnZXRQaXhlbERpc3RhbmNlKGN1cnJlbnRGcmFtZUltYWdlRGF0YSwgbGFzdEZyYW1lSW1hZ2VEYXRhLCBpKSA+IDAuMTUpIHtcbiAgICAgICAgICAgIGxldCBpbmRleCA9IGkgLyA0O1xuICAgICAgICAgICAgY2hhbmdlZEluZGV4ZXMucHVzaChpbmRleCk7XG5cbiAgICAgICAgICAgIHByb2Nlc3NlZEltYWdlRGF0YS5kYXRhW2ldID0gMDtcbiAgICAgICAgICAgIHByb2Nlc3NlZEltYWdlRGF0YS5kYXRhW2kgKyAxXSA9IDA7XG4gICAgICAgICAgICBwcm9jZXNzZWRJbWFnZURhdGEuZGF0YVtpICsgMl0gPSAwO1xuICAgICAgICAgICAgcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaSArIDNdID0gMjU1O1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnRleHQucHV0SW1hZ2VEYXRhKHByb2Nlc3NlZEltYWdlRGF0YSwgMCwgMCk7XG5cbiAgICBsZXQgY2hhbmdlZHh5ID0gY2hhbmdlZEluZGV4ZXMubWFwKGZ1bmN0aW9uKHgpe1xuICAgICAgICByZXR1cm4gaW5kZXhUb0Nvb3JkaW5hdGVzKHgsIHhwaXhlbHMpO1xuICAgIH0pXG5cbiAgICBsZXQgY2hhbmdlcyA9IGNoYW5nZWR4eS5sZW5ndGg7XG4gICAgbGV0IHN1bXggPSAwO1xuICAgIGxldCBzdW15ID0gMDtcbiAgICAvLyBsZXRcbiAgICBmb3IgKGxldCBwaXhlbCBvZiBjaGFuZ2VkeHkpIHtcbiAgICAgICAgc3VteCArPSBwaXhlbC54O1xuICAgICAgICBzdW15ICs9IHBpeGVsLnk7XG4gICAgfVxuICAgIHJldHVybiBbY2hhbmdlcywgc3VteC9jaGFuZ2VzLCBzdW15L2NoYW5nZXNdO1xuICAgIGNvbnNvbGUubG9nKGNoYW5nZSwgc3VteC9jaGFuZ2VzLCBzdW15L2NoYW5nZXMpO1xuXG4gICAgLy8gY29udGV4dC5wdXRJbWFnZURhdGEocHJvY2Vzc2VkSW1hZ2VEYXRhLCAwLCAwKTtcbn1cblxuZnVuY3Rpb24gaW5kZXhUb0Nvb3JkaW5hdGVzKGluZGV4LCB3aWR0aCkgeyAvLyByZW1lbWJlciB0aGF0IHRoZSBpbmRleCBpcyByIGcgYiBhISEhIGZpeCB0aGlzIGZ1bmN0aW9uXG4gICAgdmFyIHkgPSBNYXRoLmZsb29yKGluZGV4IC8gd2lkdGgpO1xuICAgIHZhciB4ID0gaW5kZXggLSAoeSAqIHdpZHRoKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB4OiB4LFxuICAgICAgICB5OiB5XG4gICAgfTtcbn1cblxuZnVuY3Rpb24gUmFkYXIoKSB7XG4gIGxldCBmcHMgPSAzMDtcbiAgbGV0IHJhZGFyID0gbmV3IE9iamVjdCgpO1xuICAvLyBsZXQgY29tcGFyZXIgPSBuZXcgSW1hZ2VDb21wYXJlKCk7XG4gIGxldCBwcmV2aW91c0ZyYW1lO1xuXG4gIHJhZGFyLnN0YXJ0ID0gKCkgPT4ge1xuICAgIHJhZGFyLnZpZGVvID0gZ2V0VmlkZW8oKTsgLy8gY2hhbmdlIHRvIHByb21pc2UgaW50ZXJmYWNlP1xuICB9XG5cbiAgcmFkYXIuc3RhcnRMb29wID0gKCkgPT4ge1xuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgbG9vcCgpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbG9vcCgpIHsgLy8gd2Ugc2hvdWxkIHBhc3MgaW4gdGltZSBkaWZmZXJlbmNlcz9cbiAgICBsZXQgY3VycmVudEZyYW1lID0gZ2V0VmlkZW9GcmFtZShyYWRhci52aWRlbyk7XG4gICAgcHJvY2VzcyhjdXJyZW50RnJhbWUsIHByZXZpb3VzRnJhbWUpO1xuXG4gICAgcHJldmlvdXNGcmFtZSA9IGN1cnJlbnRGcmFtZTtcblxuICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBsb29wKCk7XG4gICAgICB9KVxuICAgIH0sIDEwMDAgLyBmcHMpO1xuXG4gIH1cblxuICBmdW5jdGlvbiBwcm9jZXNzKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSkge1xuICAgIGlmIChwcmV2aW91c0ZyYW1lKSB7XG4gICAgICBsZXQgeHkgPSBjb21wYXJlKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSwgeHBpeGVscywgeXBpeGVscyk7XG5cbiAgICAgIGlmICh4eVswXSA+IDUwKXtcbiAgICAgICAgICBwb3NbMF0gPSB4eVsxXTtcbiAgICAgICAgICBwb3NbMV0gPSB4eVsyXTtcbiAgICAgICAgLy8gICBwb3NbMF0gPSB4eVsxXSAvIHlwaXhlbHNcbiAgICAgICAgLy8gICBwb3NbMV0gPSB4eVsyXSAvIHhwaXhlbHNcbiAgICAgICAgfVxuICAgICAgICAvLyBjb250ZXh0LnB1dEltYWdlRGF0YShwcm9jZXNzZWRJbWFnZURhdGEsIHBvc1swXSwgcG9zWzFdKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2cocG9zKTtcbiAgICAgICAgY29udGV4dC5maWxsU3R5bGUgPSAncmVkJztcbiAgICAgICAgY29udGV4dC5maWxsUmVjdChwb3NbMF0sIHBvc1sxXSwgMjAsIDIwKTtcbiAgICAvLyAgIGNvbnNvbGUubG9nKHh5KTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmFkYXI7XG59XG5cbi8vIHdoeSBpc24ndCB0aGlzIHNlcGFyYXRlZCBpbnRvIGZpbGVzPyE/PyFcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
