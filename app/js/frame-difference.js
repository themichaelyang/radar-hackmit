'use strict';

var debug = false;
var canvas = void 0;
var context = void 0;
var pos = [0, 0];
// let xpixels = 480;
// let ypixels = 270;

// let xpixels = 360;
// let ypixels = 200;

var xpixels = 240;
var ypixels = 135;

function getVideo() {

  canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  canvas.width = xpixels;
  canvas.height = ypixels;
  context = canvas.getContext('2d');

  // consider setting the video constraints in the individual video media track within the stream
  var video = document.createElement('video');
  var userMediaConstraints = {
    video: { width: { exact: xpixels }, height: { exact: ypixels }, facingMode: 'user' }, // set a framerate constraint?
    audio: false
  };

  navigator.mediaDevices.getUserMedia(userMediaConstraints).then(onGetUserMediaSuccess).catch(onGetUserMediaError);

  function onGetUserMediaSuccess(mediaStream) {
    video.src = window.URL.createObjectURL(mediaStream);
    video.play();
  }

  function onGetUserMediaError(error) {
    console.error(error);
  }

  document.body.appendChild(video);
  return video; // watch out! metadata doesnt load initially! its async
}

function getVideoFrame(video) {
  var canvas = document.createElement('canvas'); // consider reading raw img data from videos
  var ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return ctx;
}

function getPixelDistance(one, two, i) {
  var rdiff = one.data[i] - two.data[i];
  var gdiff = one.data[i + 1] - two.data[i + 1];
  var bdiff = one.data[i + 2] - two.data[i + 2];

  var dist = Math.floor(Math.sqrt(Math.pow(rdiff, 2) + Math.pow(gdiff, 2) + Math.pow(bdiff, 2)));
  return dist / 441;
}

function compare(currentFrame, previousFrame) {
  var changedIndexes = [];
  var currentFrameImageData = currentFrame.getImageData(0, 0, xpixels, ypixels);
  var lastFrameImageData = previousFrame.getImageData(0, 0, xpixels, ypixels);
  var processedImageData = currentFrame.createImageData(currentFrameImageData);

  for (var i = 0; i < currentFrameImageData.data.length; i += 4) {
    // canvas image data is ordered "r, g, b, a" in a clamped byte array
    // processedImageData = processedImageData.data[i, i + 3]
    if (getPixelDistance(currentFrameImageData, lastFrameImageData, i) > 0.2) {
      var index = i / 4;
      changedIndexes.push(index);

      processedImageData.data[i] = 0;
      processedImageData.data[i + 1] = 0;
      processedImageData.data[i + 2] = 0;
      processedImageData.data[i + 3] = 255;
    }
  }
  context.putImageData(processedImageData, 0, 0);

  var changedxy = changedIndexes.map(function (x) {
    return indexToCoordinates(x, xpixels);
  });

  var changes = changedxy.length;
  var sumx = 0;
  var sumy = 0;
  // let
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = changedxy[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var pixel = _step.value;

      sumx += pixel.x;
      sumy += pixel.y;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return [changes, sumx / changes, sumy / changes];
  console.log(change, sumx / changes, sumy / changes);

  // context.putImageData(processedImageData, 0, 0);
}

function indexToCoordinates(index, width) {
  // remember that the index is r g b a!!! fix this function
  var y = Math.floor(index / width);
  var x = index - y * width;
  return {
    x: x,
    y: y
  };
}

function Radar() {
  var fps = 20;
  var radar = new Object();
  // let comparer = new ImageCompare();
  var previousFrame = void 0;
  radar.coords = { x: -1, y: -1 };

  radar.start = function () {
    radar.video = getVideo(); // change to promise interface?
  };

  radar.startLoop = function (callOnLoop) {
    window.requestAnimationFrame(function () {
      loop(callOnLoop);
    });
  };

  function loop(callOnLoop) {
    // we should pass in time differences?
    var currentFrame = getVideoFrame(radar.video);
    process(currentFrame, previousFrame);

    callOnLoop();

    previousFrame = currentFrame;

    window.setTimeout(function () {
      window.requestAnimationFrame(function () {
        loop(callOnLoop);
      });
    }, 1000 / fps);
  }

  function process(currentFrame, previousFrame) {
    if (previousFrame) {
      var xy = compare(currentFrame, previousFrame, xpixels, ypixels); // this is terrible, fix this later
      var coords = {};
      if (xy[0] > 150) {
        // pos[0] = xy[1];
        // pos[1] = xy[2];
        coords.x = xy[1];
        coords.y = xy[2];

        //   pos[0] = xy[1] / ypixels
        //   pos[1] = xy[2] / xpixels
      }
      // context.putImageData(processedImageData, pos[0], pos[1]);
      // console.log(pos);
      context.fillStyle = 'red';
      context.fillRect(coords.x, coords.y, 20, 20);
      //   console.log(xy);
      radar.coords = normalizeCoordinates(coords);
    }
  }

  function normalizeCoordinates(coordinates) {
    return {
      x: coordinates.x / xpixels,
      y: coordinates.y / ypixels
    };
  }

  radar.getCoords = function () {
    return radar.coords;
  };

  return radar;
}

// why isn't this separated into files?!??!
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZyYW1lLWRpZmZlcmVuY2UuanMiXSwibmFtZXMiOlsiZGVidWciLCJjYW52YXMiLCJjb250ZXh0IiwicG9zIiwieHBpeGVscyIsInlwaXhlbHMiLCJnZXRWaWRlbyIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsInZpZGVvIiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJleGFjdCIsImZhY2luZ01vZGUiLCJhdWRpbyIsIm5hdmlnYXRvciIsIm1lZGlhRGV2aWNlcyIsImdldFVzZXJNZWRpYSIsInRoZW4iLCJvbkdldFVzZXJNZWRpYVN1Y2Nlc3MiLCJjYXRjaCIsIm9uR2V0VXNlck1lZGlhRXJyb3IiLCJtZWRpYVN0cmVhbSIsInNyYyIsIndpbmRvdyIsIlVSTCIsImNyZWF0ZU9iamVjdFVSTCIsInBsYXkiLCJlcnJvciIsImNvbnNvbGUiLCJnZXRWaWRlb0ZyYW1lIiwiY3R4IiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwiZHJhd0ltYWdlIiwiZ2V0UGl4ZWxEaXN0YW5jZSIsIm9uZSIsInR3byIsImkiLCJyZGlmZiIsImRhdGEiLCJnZGlmZiIsImJkaWZmIiwiZGlzdCIsIk1hdGgiLCJmbG9vciIsInNxcnQiLCJwb3ciLCJjb21wYXJlIiwiY3VycmVudEZyYW1lIiwicHJldmlvdXNGcmFtZSIsImNoYW5nZWRJbmRleGVzIiwiY3VycmVudEZyYW1lSW1hZ2VEYXRhIiwiZ2V0SW1hZ2VEYXRhIiwibGFzdEZyYW1lSW1hZ2VEYXRhIiwicHJvY2Vzc2VkSW1hZ2VEYXRhIiwiY3JlYXRlSW1hZ2VEYXRhIiwibGVuZ3RoIiwiaW5kZXgiLCJwdXNoIiwicHV0SW1hZ2VEYXRhIiwiY2hhbmdlZHh5IiwibWFwIiwieCIsImluZGV4VG9Db29yZGluYXRlcyIsImNoYW5nZXMiLCJzdW14Iiwic3VteSIsInBpeGVsIiwieSIsImxvZyIsImNoYW5nZSIsIlJhZGFyIiwiZnBzIiwicmFkYXIiLCJPYmplY3QiLCJjb29yZHMiLCJzdGFydCIsInN0YXJ0TG9vcCIsImNhbGxPbkxvb3AiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJsb29wIiwicHJvY2VzcyIsInNldFRpbWVvdXQiLCJ4eSIsImZpbGxTdHlsZSIsImZpbGxSZWN0Iiwibm9ybWFsaXplQ29vcmRpbmF0ZXMiLCJjb29yZGluYXRlcyIsImdldENvb3JkcyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsUUFBUSxLQUFaO0FBQ0EsSUFBSUMsZUFBSjtBQUNBLElBQUlDLGdCQUFKO0FBQ0EsSUFBSUMsTUFBTSxDQUFDLENBQUQsRUFBSSxDQUFKLENBQVY7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUEsSUFBSUMsVUFBVSxHQUFkO0FBQ0EsSUFBSUMsVUFBVSxHQUFkOztBQUdBLFNBQVNDLFFBQVQsR0FBb0I7O0FBRWhCTCxXQUFTTSxTQUFTQyxhQUFULENBQXVCLFFBQXZCLENBQVQ7QUFDQUQsV0FBU0UsSUFBVCxDQUFjQyxXQUFkLENBQTBCVCxNQUExQjtBQUNBQSxTQUFPVSxLQUFQLEdBQWVQLE9BQWY7QUFDQUgsU0FBT1csTUFBUCxHQUFnQlAsT0FBaEI7QUFDQUgsWUFBVUQsT0FBT1ksVUFBUCxDQUFrQixJQUFsQixDQUFWOztBQUVGO0FBQ0EsTUFBSUMsUUFBUVAsU0FBU0MsYUFBVCxDQUF1QixPQUF2QixDQUFaO0FBQ0EsTUFBSU8sdUJBQXVCO0FBQ3pCRCxXQUFPLEVBQUVILE9BQU8sRUFBQ0ssT0FBT1osT0FBUixFQUFULEVBQTJCUSxRQUFRLEVBQUNJLE9BQU9YLE9BQVIsRUFBbkMsRUFBcURZLFlBQVksTUFBakUsRUFEa0IsRUFDeUQ7QUFDbEZDLFdBQU87QUFGa0IsR0FBM0I7O0FBS0FDLFlBQVVDLFlBQVYsQ0FBdUJDLFlBQXZCLENBQW9DTixvQkFBcEMsRUFDdUJPLElBRHZCLENBQzRCQyxxQkFENUIsRUFFdUJDLEtBRnZCLENBRTZCQyxtQkFGN0I7O0FBSUEsV0FBU0YscUJBQVQsQ0FBK0JHLFdBQS9CLEVBQTRDO0FBQzFDWixVQUFNYSxHQUFOLEdBQVlDLE9BQU9DLEdBQVAsQ0FBV0MsZUFBWCxDQUEyQkosV0FBM0IsQ0FBWjtBQUNBWixVQUFNaUIsSUFBTjtBQUNEOztBQUVELFdBQVNOLG1CQUFULENBQTZCTyxLQUE3QixFQUFvQztBQUNsQ0MsWUFBUUQsS0FBUixDQUFjQSxLQUFkO0FBQ0Q7O0FBRUR6QixXQUFTRSxJQUFULENBQWNDLFdBQWQsQ0FBMEJJLEtBQTFCO0FBQ0EsU0FBT0EsS0FBUCxDQTdCa0IsQ0E2Qko7QUFDZjs7QUFFRCxTQUFTb0IsYUFBVCxDQUF1QnBCLEtBQXZCLEVBQThCO0FBQzVCLE1BQUliLFNBQVNNLFNBQVNDLGFBQVQsQ0FBdUIsUUFBdkIsQ0FBYixDQUQ0QixDQUNtQjtBQUMvQyxNQUFJMkIsTUFBTWxDLE9BQU9ZLFVBQVAsQ0FBa0IsSUFBbEIsQ0FBVjtBQUNBWixTQUFPVSxLQUFQLEdBQWVHLE1BQU1zQixVQUFyQjtBQUNBbkMsU0FBT1csTUFBUCxHQUFnQkUsTUFBTXVCLFdBQXRCO0FBQ0FGLE1BQUlHLFNBQUosQ0FBY3hCLEtBQWQsRUFBcUIsQ0FBckIsRUFBd0IsQ0FBeEIsRUFBMkJiLE9BQU9VLEtBQWxDLEVBQXlDVixPQUFPVyxNQUFoRDtBQUNBLFNBQU91QixHQUFQO0FBQ0Q7O0FBRUQsU0FBU0ksZ0JBQVQsQ0FBMEJDLEdBQTFCLEVBQStCQyxHQUEvQixFQUFvQ0MsQ0FBcEMsRUFBdUM7QUFDbkMsTUFBSUMsUUFBUUgsSUFBSUksSUFBSixDQUFTRixDQUFULElBQWNELElBQUlHLElBQUosQ0FBU0YsQ0FBVCxDQUExQjtBQUNBLE1BQUlHLFFBQVFMLElBQUlJLElBQUosQ0FBU0YsSUFBSSxDQUFiLElBQWtCRCxJQUFJRyxJQUFKLENBQVNGLElBQUksQ0FBYixDQUE5QjtBQUNBLE1BQUlJLFFBQVFOLElBQUlJLElBQUosQ0FBU0YsSUFBSSxDQUFiLElBQWtCRCxJQUFJRyxJQUFKLENBQVNGLElBQUksQ0FBYixDQUE5Qjs7QUFFQSxNQUFJSyxPQUFPQyxLQUFLQyxLQUFMLENBQVdELEtBQUtFLElBQUwsQ0FBVUYsS0FBS0csR0FBTCxDQUFTUixLQUFULEVBQWdCLENBQWhCLElBQXFCSyxLQUFLRyxHQUFMLENBQVNOLEtBQVQsRUFBZ0IsQ0FBaEIsQ0FBckIsR0FBMENHLEtBQUtHLEdBQUwsQ0FBU0wsS0FBVCxFQUFnQixDQUFoQixDQUFwRCxDQUFYLENBQVg7QUFDQSxTQUFPQyxPQUFPLEdBQWQ7QUFDSDs7QUFFRCxTQUFTSyxPQUFULENBQWlCQyxZQUFqQixFQUErQkMsYUFBL0IsRUFBOEM7QUFDMUMsTUFBSUMsaUJBQWlCLEVBQXJCO0FBQ0EsTUFBSUMsd0JBQXdCSCxhQUFhSSxZQUFiLENBQTBCLENBQTFCLEVBQTZCLENBQTdCLEVBQWdDckQsT0FBaEMsRUFBeUNDLE9BQXpDLENBQTVCO0FBQ0EsTUFBSXFELHFCQUFxQkosY0FBY0csWUFBZCxDQUEyQixDQUEzQixFQUE4QixDQUE5QixFQUFpQ3JELE9BQWpDLEVBQTBDQyxPQUExQyxDQUF6QjtBQUNELE1BQUlzRCxxQkFBcUJOLGFBQWFPLGVBQWIsQ0FBNkJKLHFCQUE3QixDQUF6Qjs7QUFFQyxPQUFLLElBQUlkLElBQUksQ0FBYixFQUFnQkEsSUFBSWMsc0JBQXNCWixJQUF0QixDQUEyQmlCLE1BQS9DLEVBQXVEbkIsS0FBSyxDQUE1RCxFQUErRDtBQUMzRDtBQUNBO0FBQ0EsUUFBSUgsaUJBQWlCaUIscUJBQWpCLEVBQXdDRSxrQkFBeEMsRUFBNERoQixDQUE1RCxJQUFpRSxHQUFyRSxFQUEwRTtBQUN0RSxVQUFJb0IsUUFBUXBCLElBQUksQ0FBaEI7QUFDQWEscUJBQWVRLElBQWYsQ0FBb0JELEtBQXBCOztBQUVBSCx5QkFBbUJmLElBQW5CLENBQXdCRixDQUF4QixJQUE2QixDQUE3QjtBQUNBaUIseUJBQW1CZixJQUFuQixDQUF3QkYsSUFBSSxDQUE1QixJQUFpQyxDQUFqQztBQUNBaUIseUJBQW1CZixJQUFuQixDQUF3QkYsSUFBSSxDQUE1QixJQUFpQyxDQUFqQztBQUNBaUIseUJBQW1CZixJQUFuQixDQUF3QkYsSUFBSSxDQUE1QixJQUFpQyxHQUFqQztBQUNIO0FBQ0o7QUFDRHhDLFVBQVE4RCxZQUFSLENBQXFCTCxrQkFBckIsRUFBeUMsQ0FBekMsRUFBNEMsQ0FBNUM7O0FBRUEsTUFBSU0sWUFBWVYsZUFBZVcsR0FBZixDQUFtQixVQUFTQyxDQUFULEVBQVc7QUFDMUMsV0FBT0MsbUJBQW1CRCxDQUFuQixFQUFzQi9ELE9BQXRCLENBQVA7QUFDSCxHQUZlLENBQWhCOztBQUlBLE1BQUlpRSxVQUFVSixVQUFVSixNQUF4QjtBQUNBLE1BQUlTLE9BQU8sQ0FBWDtBQUNBLE1BQUlDLE9BQU8sQ0FBWDtBQUNBO0FBNUIwQztBQUFBO0FBQUE7O0FBQUE7QUE2QjFDLHlCQUFrQk4sU0FBbEIsOEhBQTZCO0FBQUEsVUFBcEJPLEtBQW9COztBQUN6QkYsY0FBUUUsTUFBTUwsQ0FBZDtBQUNBSSxjQUFRQyxNQUFNQyxDQUFkO0FBQ0g7QUFoQ3lDO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBaUMxQyxTQUFPLENBQUNKLE9BQUQsRUFBVUMsT0FBS0QsT0FBZixFQUF3QkUsT0FBS0YsT0FBN0IsQ0FBUDtBQUNBcEMsVUFBUXlDLEdBQVIsQ0FBWUMsTUFBWixFQUFvQkwsT0FBS0QsT0FBekIsRUFBa0NFLE9BQUtGLE9BQXZDOztBQUVBO0FBQ0g7O0FBRUQsU0FBU0Qsa0JBQVQsQ0FBNEJOLEtBQTVCLEVBQW1DbkQsS0FBbkMsRUFBMEM7QUFBRTtBQUN4QyxNQUFJOEQsSUFBSXpCLEtBQUtDLEtBQUwsQ0FBV2EsUUFBUW5ELEtBQW5CLENBQVI7QUFDQSxNQUFJd0QsSUFBSUwsUUFBU1csSUFBSTlELEtBQXJCO0FBQ0EsU0FBTztBQUNId0QsT0FBR0EsQ0FEQTtBQUVITSxPQUFHQTtBQUZBLEdBQVA7QUFJSDs7QUFFRCxTQUFTRyxLQUFULEdBQWlCO0FBQ2YsTUFBSUMsTUFBTSxFQUFWO0FBQ0EsTUFBSUMsUUFBUSxJQUFJQyxNQUFKLEVBQVo7QUFDQTtBQUNBLE1BQUl6QixzQkFBSjtBQUNBd0IsUUFBTUUsTUFBTixHQUFlLEVBQUNiLEdBQUcsQ0FBQyxDQUFMLEVBQVFNLEdBQUcsQ0FBQyxDQUFaLEVBQWY7O0FBRUFLLFFBQU1HLEtBQU4sR0FBYyxZQUFNO0FBQ2xCSCxVQUFNaEUsS0FBTixHQUFjUixVQUFkLENBRGtCLENBQ1E7QUFDM0IsR0FGRDs7QUFJQXdFLFFBQU1JLFNBQU4sR0FBa0IsVUFBU0MsVUFBVCxFQUFxQjtBQUNyQ3ZELFdBQU93RCxxQkFBUCxDQUE2QixZQUFNO0FBQ2pDQyxXQUFLRixVQUFMO0FBQ0QsS0FGRDtBQUdELEdBSkQ7O0FBTUEsV0FBU0UsSUFBVCxDQUFjRixVQUFkLEVBQTBCO0FBQUU7QUFDMUIsUUFBSTlCLGVBQWVuQixjQUFjNEMsTUFBTWhFLEtBQXBCLENBQW5CO0FBQ0F3RSxZQUFRakMsWUFBUixFQUFzQkMsYUFBdEI7O0FBRUE2Qjs7QUFFQTdCLG9CQUFnQkQsWUFBaEI7O0FBRUF6QixXQUFPMkQsVUFBUCxDQUFrQixZQUFNO0FBQ3RCM0QsYUFBT3dELHFCQUFQLENBQTZCLFlBQU07QUFDakNDLGFBQUtGLFVBQUw7QUFDRCxPQUZEO0FBR0QsS0FKRCxFQUlHLE9BQU9OLEdBSlY7QUFNRDs7QUFFRCxXQUFTUyxPQUFULENBQWlCakMsWUFBakIsRUFBK0JDLGFBQS9CLEVBQThDO0FBQzVDLFFBQUlBLGFBQUosRUFBbUI7QUFDakIsVUFBSWtDLEtBQUtwQyxRQUFRQyxZQUFSLEVBQXNCQyxhQUF0QixFQUFxQ2xELE9BQXJDLEVBQThDQyxPQUE5QyxDQUFULENBRGlCLENBQ2dEO0FBQ2pFLFVBQUkyRSxTQUFTLEVBQWI7QUFDQSxVQUFJUSxHQUFHLENBQUgsSUFBUSxHQUFaLEVBQWdCO0FBQ1o7QUFDQTtBQUNBUixlQUFPYixDQUFQLEdBQVdxQixHQUFHLENBQUgsQ0FBWDtBQUNBUixlQUFPUCxDQUFQLEdBQVdlLEdBQUcsQ0FBSCxDQUFYOztBQUVGO0FBQ0E7QUFDQztBQUNEO0FBQ0E7QUFDQXRGLGNBQVF1RixTQUFSLEdBQW9CLEtBQXBCO0FBQ0F2RixjQUFRd0YsUUFBUixDQUFpQlYsT0FBT2IsQ0FBeEIsRUFBMkJhLE9BQU9QLENBQWxDLEVBQXFDLEVBQXJDLEVBQXlDLEVBQXpDO0FBQ0o7QUFDSUssWUFBTUUsTUFBTixHQUFlVyxxQkFBcUJYLE1BQXJCLENBQWY7QUFDSDtBQUNGOztBQUVELFdBQVNXLG9CQUFULENBQThCQyxXQUE5QixFQUEyQztBQUN6QyxXQUFPO0FBQ0x6QixTQUFHeUIsWUFBWXpCLENBQVosR0FBZ0IvRCxPQURkO0FBRUxxRSxTQUFHbUIsWUFBWW5CLENBQVosR0FBZ0JwRTtBQUZkLEtBQVA7QUFJRDs7QUFFRHlFLFFBQU1lLFNBQU4sR0FBa0IsWUFBVztBQUMzQixXQUFPZixNQUFNRSxNQUFiO0FBQ0QsR0FGRDs7QUFJQSxTQUFPRixLQUFQO0FBQ0Q7O0FBRUQiLCJmaWxlIjoiZnJhbWUtZGlmZmVyZW5jZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxubGV0IGRlYnVnID0gZmFsc2U7XG5sZXQgY2FudmFzO1xubGV0IGNvbnRleHQ7XG5sZXQgcG9zID0gWzAsIDBdO1xuLy8gbGV0IHhwaXhlbHMgPSA0ODA7XG4vLyBsZXQgeXBpeGVscyA9IDI3MDtcblxuLy8gbGV0IHhwaXhlbHMgPSAzNjA7XG4vLyBsZXQgeXBpeGVscyA9IDIwMDtcblxubGV0IHhwaXhlbHMgPSAyNDA7XG5sZXQgeXBpeGVscyA9IDEzNTtcblxuXG5mdW5jdGlvbiBnZXRWaWRlbygpIHtcblxuICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcbiAgICBjYW52YXMud2lkdGggPSB4cGl4ZWxzO1xuICAgIGNhbnZhcy5oZWlnaHQgPSB5cGl4ZWxzO1xuICAgIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKVxuXG4gIC8vIGNvbnNpZGVyIHNldHRpbmcgdGhlIHZpZGVvIGNvbnN0cmFpbnRzIGluIHRoZSBpbmRpdmlkdWFsIHZpZGVvIG1lZGlhIHRyYWNrIHdpdGhpbiB0aGUgc3RyZWFtXG4gIGxldCB2aWRlbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ZpZGVvJyk7XG4gIGxldCB1c2VyTWVkaWFDb25zdHJhaW50cyA9IHtcbiAgICB2aWRlbzogeyB3aWR0aDoge2V4YWN0OiB4cGl4ZWxzfSwgaGVpZ2h0OiB7ZXhhY3Q6IHlwaXhlbHN9LCBmYWNpbmdNb2RlOiAndXNlcicgfSwgLy8gc2V0IGEgZnJhbWVyYXRlIGNvbnN0cmFpbnQ/XG4gICAgYXVkaW86IGZhbHNlXG4gIH07XG5cbiAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEodXNlck1lZGlhQ29uc3RyYWludHMpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihvbkdldFVzZXJNZWRpYVN1Y2Nlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2gob25HZXRVc2VyTWVkaWFFcnJvcik7XG5cbiAgZnVuY3Rpb24gb25HZXRVc2VyTWVkaWFTdWNjZXNzKG1lZGlhU3RyZWFtKSB7XG4gICAgdmlkZW8uc3JjID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobWVkaWFTdHJlYW0pO1xuICAgIHZpZGVvLnBsYXkoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uR2V0VXNlck1lZGlhRXJyb3IoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxuXG4gIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodmlkZW8pO1xuICByZXR1cm4gdmlkZW87IC8vIHdhdGNoIG91dCEgbWV0YWRhdGEgZG9lc250IGxvYWQgaW5pdGlhbGx5ISBpdHMgYXN5bmNcbn1cblxuZnVuY3Rpb24gZ2V0VmlkZW9GcmFtZSh2aWRlbykge1xuICBsZXQgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7IC8vIGNvbnNpZGVyIHJlYWRpbmcgcmF3IGltZyBkYXRhIGZyb20gdmlkZW9zXG4gIGxldCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgY2FudmFzLndpZHRoID0gdmlkZW8udmlkZW9XaWR0aDtcbiAgY2FudmFzLmhlaWdodCA9IHZpZGVvLnZpZGVvSGVpZ2h0O1xuICBjdHguZHJhd0ltYWdlKHZpZGVvLCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpXG4gIHJldHVybiBjdHg7XG59XG5cbmZ1bmN0aW9uIGdldFBpeGVsRGlzdGFuY2Uob25lLCB0d28sIGkpIHtcbiAgICB2YXIgcmRpZmYgPSBvbmUuZGF0YVtpXSAtIHR3by5kYXRhW2ldO1xuICAgIHZhciBnZGlmZiA9IG9uZS5kYXRhW2kgKyAxXSAtIHR3by5kYXRhW2kgKyAxXTtcbiAgICB2YXIgYmRpZmYgPSBvbmUuZGF0YVtpICsgMl0gLSB0d28uZGF0YVtpICsgMl07XG5cbiAgICB2YXIgZGlzdCA9IE1hdGguZmxvb3IoTWF0aC5zcXJ0KE1hdGgucG93KHJkaWZmLCAyKSArIE1hdGgucG93KGdkaWZmLCAyKSArIE1hdGgucG93KGJkaWZmLCAyKSkpO1xuICAgIHJldHVybiBkaXN0IC8gNDQxO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSkge1xuICAgIGxldCBjaGFuZ2VkSW5kZXhlcyA9IFtdXG4gICAgbGV0IGN1cnJlbnRGcmFtZUltYWdlRGF0YSA9IGN1cnJlbnRGcmFtZS5nZXRJbWFnZURhdGEoMCwgMCwgeHBpeGVscywgeXBpeGVscyk7XG4gICAgbGV0IGxhc3RGcmFtZUltYWdlRGF0YSA9IHByZXZpb3VzRnJhbWUuZ2V0SW1hZ2VEYXRhKDAsIDAsIHhwaXhlbHMsIHlwaXhlbHMpO1xuXHQgIGxldCBwcm9jZXNzZWRJbWFnZURhdGEgPSBjdXJyZW50RnJhbWUuY3JlYXRlSW1hZ2VEYXRhKGN1cnJlbnRGcmFtZUltYWdlRGF0YSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnJlbnRGcmFtZUltYWdlRGF0YS5kYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICAgIC8vIGNhbnZhcyBpbWFnZSBkYXRhIGlzIG9yZGVyZWQgXCJyLCBnLCBiLCBhXCIgaW4gYSBjbGFtcGVkIGJ5dGUgYXJyYXlcbiAgICAgICAgLy8gcHJvY2Vzc2VkSW1hZ2VEYXRhID0gcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaSwgaSArIDNdXG4gICAgICAgIGlmIChnZXRQaXhlbERpc3RhbmNlKGN1cnJlbnRGcmFtZUltYWdlRGF0YSwgbGFzdEZyYW1lSW1hZ2VEYXRhLCBpKSA+IDAuMikge1xuICAgICAgICAgICAgbGV0IGluZGV4ID0gaSAvIDQ7XG4gICAgICAgICAgICBjaGFuZ2VkSW5kZXhlcy5wdXNoKGluZGV4KTtcblxuICAgICAgICAgICAgcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaV0gPSAwO1xuICAgICAgICAgICAgcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaSArIDFdID0gMDtcbiAgICAgICAgICAgIHByb2Nlc3NlZEltYWdlRGF0YS5kYXRhW2kgKyAyXSA9IDA7XG4gICAgICAgICAgICBwcm9jZXNzZWRJbWFnZURhdGEuZGF0YVtpICsgM10gPSAyNTU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29udGV4dC5wdXRJbWFnZURhdGEocHJvY2Vzc2VkSW1hZ2VEYXRhLCAwLCAwKTtcblxuICAgIGxldCBjaGFuZ2VkeHkgPSBjaGFuZ2VkSW5kZXhlcy5tYXAoZnVuY3Rpb24oeCl7XG4gICAgICAgIHJldHVybiBpbmRleFRvQ29vcmRpbmF0ZXMoeCwgeHBpeGVscyk7XG4gICAgfSlcblxuICAgIGxldCBjaGFuZ2VzID0gY2hhbmdlZHh5Lmxlbmd0aDtcbiAgICBsZXQgc3VteCA9IDA7XG4gICAgbGV0IHN1bXkgPSAwO1xuICAgIC8vIGxldFxuICAgIGZvciAobGV0IHBpeGVsIG9mIGNoYW5nZWR4eSkge1xuICAgICAgICBzdW14ICs9IHBpeGVsLng7XG4gICAgICAgIHN1bXkgKz0gcGl4ZWwueTtcbiAgICB9XG4gICAgcmV0dXJuIFtjaGFuZ2VzLCBzdW14L2NoYW5nZXMsIHN1bXkvY2hhbmdlc107XG4gICAgY29uc29sZS5sb2coY2hhbmdlLCBzdW14L2NoYW5nZXMsIHN1bXkvY2hhbmdlcyk7XG5cbiAgICAvLyBjb250ZXh0LnB1dEltYWdlRGF0YShwcm9jZXNzZWRJbWFnZURhdGEsIDAsIDApO1xufVxuXG5mdW5jdGlvbiBpbmRleFRvQ29vcmRpbmF0ZXMoaW5kZXgsIHdpZHRoKSB7IC8vIHJlbWVtYmVyIHRoYXQgdGhlIGluZGV4IGlzIHIgZyBiIGEhISEgZml4IHRoaXMgZnVuY3Rpb25cbiAgICB2YXIgeSA9IE1hdGguZmxvb3IoaW5kZXggLyB3aWR0aCk7XG4gICAgdmFyIHggPSBpbmRleCAtICh5ICogd2lkdGgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHg6IHgsXG4gICAgICAgIHk6IHlcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBSYWRhcigpIHtcbiAgbGV0IGZwcyA9IDIwO1xuICBsZXQgcmFkYXIgPSBuZXcgT2JqZWN0KCk7XG4gIC8vIGxldCBjb21wYXJlciA9IG5ldyBJbWFnZUNvbXBhcmUoKTtcbiAgbGV0IHByZXZpb3VzRnJhbWU7XG4gIHJhZGFyLmNvb3JkcyA9IHt4OiAtMSwgeTogLTF9O1xuXG4gIHJhZGFyLnN0YXJ0ID0gKCkgPT4ge1xuICAgIHJhZGFyLnZpZGVvID0gZ2V0VmlkZW8oKTsgLy8gY2hhbmdlIHRvIHByb21pc2UgaW50ZXJmYWNlP1xuICB9XG5cbiAgcmFkYXIuc3RhcnRMb29wID0gZnVuY3Rpb24oY2FsbE9uTG9vcCkge1xuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgbG9vcChjYWxsT25Mb29wKTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGxvb3AoY2FsbE9uTG9vcCkgeyAvLyB3ZSBzaG91bGQgcGFzcyBpbiB0aW1lIGRpZmZlcmVuY2VzP1xuICAgIGxldCBjdXJyZW50RnJhbWUgPSBnZXRWaWRlb0ZyYW1lKHJhZGFyLnZpZGVvKTtcbiAgICBwcm9jZXNzKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSk7XG5cbiAgICBjYWxsT25Mb29wKCk7XG5cbiAgICBwcmV2aW91c0ZyYW1lID0gY3VycmVudEZyYW1lO1xuXG4gICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIGxvb3AoY2FsbE9uTG9vcCk7XG4gICAgICB9KVxuICAgIH0sIDEwMDAgLyBmcHMpO1xuXG4gIH1cblxuICBmdW5jdGlvbiBwcm9jZXNzKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSkge1xuICAgIGlmIChwcmV2aW91c0ZyYW1lKSB7XG4gICAgICBsZXQgeHkgPSBjb21wYXJlKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSwgeHBpeGVscywgeXBpeGVscyk7IC8vIHRoaXMgaXMgdGVycmlibGUsIGZpeCB0aGlzIGxhdGVyXG4gICAgICBsZXQgY29vcmRzID0ge307XG4gICAgICBpZiAoeHlbMF0gPiAxNTApe1xuICAgICAgICAgIC8vIHBvc1swXSA9IHh5WzFdO1xuICAgICAgICAgIC8vIHBvc1sxXSA9IHh5WzJdO1xuICAgICAgICAgIGNvb3Jkcy54ID0geHlbMV07XG4gICAgICAgICAgY29vcmRzLnkgPSB4eVsyXTtcblxuICAgICAgICAvLyAgIHBvc1swXSA9IHh5WzFdIC8geXBpeGVsc1xuICAgICAgICAvLyAgIHBvc1sxXSA9IHh5WzJdIC8geHBpeGVsc1xuICAgICAgICB9XG4gICAgICAgIC8vIGNvbnRleHQucHV0SW1hZ2VEYXRhKHByb2Nlc3NlZEltYWdlRGF0YSwgcG9zWzBdLCBwb3NbMV0pO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhwb3MpO1xuICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9ICdyZWQnO1xuICAgICAgICBjb250ZXh0LmZpbGxSZWN0KGNvb3Jkcy54LCBjb29yZHMueSwgMjAsIDIwKTtcbiAgICAvLyAgIGNvbnNvbGUubG9nKHh5KTtcbiAgICAgICAgcmFkYXIuY29vcmRzID0gbm9ybWFsaXplQ29vcmRpbmF0ZXMoY29vcmRzKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBub3JtYWxpemVDb29yZGluYXRlcyhjb29yZGluYXRlcykge1xuICAgIHJldHVybiB7XG4gICAgICB4OiBjb29yZGluYXRlcy54IC8geHBpeGVscyxcbiAgICAgIHk6IGNvb3JkaW5hdGVzLnkgLyB5cGl4ZWxzXG4gICAgfVxuICB9XG5cbiAgcmFkYXIuZ2V0Q29vcmRzID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHJhZGFyLmNvb3JkcztcbiAgfVxuXG4gIHJldHVybiByYWRhcjtcbn1cblxuLy8gd2h5IGlzbid0IHRoaXMgc2VwYXJhdGVkIGludG8gZmlsZXM/IT8/IVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
