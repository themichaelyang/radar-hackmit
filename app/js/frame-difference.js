'use strict';

var debug = false;
var canvas = void 0;
var context = void 0;
var pos = [0, 0];
var xpixels = 480;
var ypixels = 270;

function getVideo() {

  canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  canvas.width = xpixels;
  canvas.height = ypixels;
  context = canvas.getContext('2d');

  // consider setting the video constraints in the individual video media track within the stream
  var video = document.createElement('video');
  var userMediaConstraints = {
    video: { width: { exact: xpixels }, height: { exact: ypixels }, facingMode: 'user' }, // set a framerate constraint?
    audio: false
  };

  navigator.mediaDevices.getUserMedia(userMediaConstraints).then(onGetUserMediaSuccess).catch(onGetUserMediaError);

  function onGetUserMediaSuccess(mediaStream) {
    video.src = window.URL.createObjectURL(mediaStream);
    video.play();
  }

  function onGetUserMediaError(error) {
    console.error(error);
  }

  document.body.appendChild(video);
  return video; // watch out! metadata doesnt load initially! its async
}

function getVideoFrame(video) {
  var canvas = document.createElement('canvas'); // consider reading raw img data from videos
  var ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return ctx;
}

function getPixelDistance(one, two, i) {
  var rdiff = one.data[i] - two.data[i];
  var gdiff = one.data[i + 1] - two.data[i + 1];
  var bdiff = one.data[i + 2] - two.data[i + 2];

  var dist = Math.floor(Math.sqrt(Math.pow(rdiff, 2) + Math.pow(gdiff, 2) + Math.pow(bdiff, 2)));
  return dist / 441;
}

function compare(currentFrame, previousFrame) {
  var changedIndexes = [];
  var currentFrameImageData = currentFrame.getImageData(0, 0, xpixels, ypixels);
  var lastFrameImageData = previousFrame.getImageData(0, 0, xpixels, ypixels);
  var processedImageData = currentFrame.createImageData(currentFrameImageData);

  for (var i = 0; i < currentFrameImageData.data.length; i += 4) {
    // canvas image data is ordered "r, g, b, a" in a clamped byte array
    // processedImageData = processedImageData.data[i, i + 3]
    if (getPixelDistance(currentFrameImageData, lastFrameImageData, i) > 0.2) {
      var index = i / 4;
      changedIndexes.push(index);

      processedImageData.data[i] = 0;
      processedImageData.data[i + 1] = 0;
      processedImageData.data[i + 2] = 0;
      processedImageData.data[i + 3] = 255;
    }
  }
  context.putImageData(processedImageData, 0, 0);

  var changedxy = changedIndexes.map(function (x) {
    return indexToCoordinates(x, xpixels);
  });

  var changes = changedxy.length;
  var sumx = 0;
  var sumy = 0;
  // let
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = changedxy[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var pixel = _step.value;

      sumx += pixel.x;
      sumy += pixel.y;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return [changes, sumx / changes, sumy / changes];
  console.log(change, sumx / changes, sumy / changes);

  // context.putImageData(processedImageData, 0, 0);
}

function indexToCoordinates(index, width) {
  // remember that the index is r g b a!!! fix this function
  var y = Math.floor(index / width);
  var x = index - y * width;
  return {
    x: x,
    y: y
  };
}

function Radar() {
  var fps = 16;
  var radar = new Object();
  // let comparer = new ImageCompare();
  var previousFrame = void 0;

  radar.start = function () {
    radar.video = getVideo(); // change to promise interface?
  };

  radar.startLoop = function () {
    window.requestAnimationFrame(function () {
      loop();
    });
  };

  function loop() {
    // we should pass in time differences?
    var currentFrame = getVideoFrame(radar.video);
    process(currentFrame, previousFrame);

    previousFrame = currentFrame;

    window.setTimeout(function () {
      window.requestAnimationFrame(function () {
        loop();
      });
    }, 1000 / fps);
  }

  function process(currentFrame, previousFrame) {
    if (previousFrame) {
      var xy = compare(currentFrame, previousFrame, xpixels, ypixels);

      if (xy[0] > 50) {
        pos[0] = xy[1];
        pos[1] = xy[2];
        //   pos[0] = xy[1] / ypixels
        //   pos[1] = xy[2] / xpixels
      }
      // context.putImageData(processedImageData, pos[0], pos[1]);
      console.log(pos);
      context.fillStyle = 'red';
      context.fillRect(pos[0], pos[1], 20, 20);
      //   console.log(xy);
    }
  }

  return radar;
}

function main() {
  var r = Radar();
  r.start();

  window.setTimeout(function () {
    r.startLoop();
  }, 500); // absolute trash, please use promises next time
}

window.onload = main;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZyYW1lLWRpZmZlcmVuY2UuanMiXSwibmFtZXMiOlsiZGVidWciLCJjYW52YXMiLCJjb250ZXh0IiwicG9zIiwieHBpeGVscyIsInlwaXhlbHMiLCJnZXRWaWRlbyIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsInZpZGVvIiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJleGFjdCIsImZhY2luZ01vZGUiLCJhdWRpbyIsIm5hdmlnYXRvciIsIm1lZGlhRGV2aWNlcyIsImdldFVzZXJNZWRpYSIsInRoZW4iLCJvbkdldFVzZXJNZWRpYVN1Y2Nlc3MiLCJjYXRjaCIsIm9uR2V0VXNlck1lZGlhRXJyb3IiLCJtZWRpYVN0cmVhbSIsInNyYyIsIndpbmRvdyIsIlVSTCIsImNyZWF0ZU9iamVjdFVSTCIsInBsYXkiLCJlcnJvciIsImNvbnNvbGUiLCJnZXRWaWRlb0ZyYW1lIiwiY3R4IiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwiZHJhd0ltYWdlIiwiZ2V0UGl4ZWxEaXN0YW5jZSIsIm9uZSIsInR3byIsImkiLCJyZGlmZiIsImRhdGEiLCJnZGlmZiIsImJkaWZmIiwiZGlzdCIsIk1hdGgiLCJmbG9vciIsInNxcnQiLCJwb3ciLCJjb21wYXJlIiwiY3VycmVudEZyYW1lIiwicHJldmlvdXNGcmFtZSIsImNoYW5nZWRJbmRleGVzIiwiY3VycmVudEZyYW1lSW1hZ2VEYXRhIiwiZ2V0SW1hZ2VEYXRhIiwibGFzdEZyYW1lSW1hZ2VEYXRhIiwicHJvY2Vzc2VkSW1hZ2VEYXRhIiwiY3JlYXRlSW1hZ2VEYXRhIiwibGVuZ3RoIiwiaW5kZXgiLCJwdXNoIiwicHV0SW1hZ2VEYXRhIiwiY2hhbmdlZHh5IiwibWFwIiwieCIsImluZGV4VG9Db29yZGluYXRlcyIsImNoYW5nZXMiLCJzdW14Iiwic3VteSIsInBpeGVsIiwieSIsImxvZyIsImNoYW5nZSIsIlJhZGFyIiwiZnBzIiwicmFkYXIiLCJPYmplY3QiLCJzdGFydCIsInN0YXJ0TG9vcCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImxvb3AiLCJwcm9jZXNzIiwic2V0VGltZW91dCIsInh5IiwiZmlsbFN0eWxlIiwiZmlsbFJlY3QiLCJtYWluIiwiciIsIm9ubG9hZCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsUUFBUSxLQUFaO0FBQ0EsSUFBSUMsZUFBSjtBQUNBLElBQUlDLGdCQUFKO0FBQ0EsSUFBSUMsTUFBTSxDQUFDLENBQUQsRUFBSSxDQUFKLENBQVY7QUFDQSxJQUFJQyxVQUFVLEdBQWQ7QUFDQSxJQUFJQyxVQUFVLEdBQWQ7O0FBRUEsU0FBU0MsUUFBVCxHQUFvQjs7QUFFaEJMLFdBQVNNLFNBQVNDLGFBQVQsQ0FBdUIsUUFBdkIsQ0FBVDtBQUNBRCxXQUFTRSxJQUFULENBQWNDLFdBQWQsQ0FBMEJULE1BQTFCO0FBQ0FBLFNBQU9VLEtBQVAsR0FBZVAsT0FBZjtBQUNBSCxTQUFPVyxNQUFQLEdBQWdCUCxPQUFoQjtBQUNBSCxZQUFVRCxPQUFPWSxVQUFQLENBQWtCLElBQWxCLENBQVY7O0FBRUY7QUFDQSxNQUFJQyxRQUFRUCxTQUFTQyxhQUFULENBQXVCLE9BQXZCLENBQVo7QUFDQSxNQUFJTyx1QkFBdUI7QUFDekJELFdBQU8sRUFBRUgsT0FBTyxFQUFDSyxPQUFPWixPQUFSLEVBQVQsRUFBMkJRLFFBQVEsRUFBQ0ksT0FBT1gsT0FBUixFQUFuQyxFQUFxRFksWUFBWSxNQUFqRSxFQURrQixFQUN5RDtBQUNsRkMsV0FBTztBQUZrQixHQUEzQjs7QUFLQUMsWUFBVUMsWUFBVixDQUF1QkMsWUFBdkIsQ0FBb0NOLG9CQUFwQyxFQUN1Qk8sSUFEdkIsQ0FDNEJDLHFCQUQ1QixFQUV1QkMsS0FGdkIsQ0FFNkJDLG1CQUY3Qjs7QUFJQSxXQUFTRixxQkFBVCxDQUErQkcsV0FBL0IsRUFBNEM7QUFDMUNaLFVBQU1hLEdBQU4sR0FBWUMsT0FBT0MsR0FBUCxDQUFXQyxlQUFYLENBQTJCSixXQUEz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QUVWLEtBQUY7O0FBRUFwRCxTQUFPeUQsVUFBUCxDQUFrQixZQUFJO0FBQUNLLE1BQUVULFNBQUY7QUFBYyxHQUFyQyxFQUF1QyxHQUF2QyxFQUpjLENBSStCO0FBQzlDOztBQUVEckQsT0FBTytELE1BQVAsR0FBZ0JGLElBQWhCIiwiZmlsZSI6ImZyYW1lLWRpZmZlcmVuY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmxldCBkZWJ1ZyA9IGZhbHNlO1xubGV0IGNhbnZhcztcbmxldCBjb250ZXh0O1xubGV0IHBvcyA9IFswLCAwXTtcbmxldCB4cGl4ZWxzID0gNDgwO1xubGV0IHlwaXhlbHMgPSAyNzA7XG5cbmZ1bmN0aW9uIGdldFZpZGVvKCkge1xuXG4gICAgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjYW52YXMpO1xuICAgIGNhbnZhcy53aWR0aCA9IHhwaXhlbHM7XG4gICAgY2FudmFzLmhlaWdodCA9IHlwaXhlbHM7XG4gICAgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpXG5cbiAgLy8gY29uc2lkZXIgc2V0dGluZyB0aGUgdmlkZW8gY29uc3RyYWludHMgaW4gdGhlIGluZGl2aWR1YWwgdmlkZW8gbWVkaWEgdHJhY2sgd2l0aGluIHRoZSBzdHJlYW1cbiAgbGV0IHZpZGVvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndmlkZW8nKTtcbiAgbGV0IHVzZXJNZWRpYUNvbnN0cmFpbnRzID0ge1xuICAgIHZpZGVvOiB7IHdpZHRoOiB7ZXhhY3Q6IHhwaXhlbHN9LCBoZWlnaHQ6IHtleGFjdDogeXBpeGVsc30sIGZhY2luZ01vZGU6ICd1c2VyJyB9LCAvLyBzZXQgYSBmcmFtZXJhdGUgY29uc3RyYWludD9cbiAgICBhdWRpbzogZmFsc2VcbiAgfTtcblxuICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh1c2VyTWVkaWFDb25zdHJhaW50cylcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKG9uR2V0VXNlck1lZGlhU3VjY2VzcylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChvbkdldFVzZXJNZWRpYUVycm9yKTtcblxuICBmdW5jdGlvbiBvbkdldFVzZXJNZWRpYVN1Y2Nlc3MobWVkaWFTdHJlYW0pIHtcbiAgICB2aWRlby5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChtZWRpYVN0cmVhbSk7XG4gICAgdmlkZW8ucGxheSgpO1xuICB9XG5cbiAgZnVuY3Rpb24gb25HZXRVc2VyTWVkaWFFcnJvcihlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh2aWRlbyk7XG4gIHJldHVybiB2aWRlbzsgLy8gd2F0Y2ggb3V0ISBtZXRhZGF0YSBkb2VzbnQgbG9hZCBpbml0aWFsbHkhIGl0cyBhc3luY1xufVxuXG5mdW5jdGlvbiBnZXRWaWRlb0ZyYW1lKHZpZGVvKSB7XG4gIGxldCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsgLy8gY29uc2lkZXIgcmVhZGluZyByYXcgaW1nIGRhdGEgZnJvbSB2aWRlb3NcbiAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICBjYW52YXMud2lkdGggPSB2aWRlby52aWRlb1dpZHRoO1xuICBjYW52YXMuaGVpZ2h0ID0gdmlkZW8udmlkZW9IZWlnaHQ7XG4gIGN0eC5kcmF3SW1hZ2UodmlkZW8sIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodClcbiAgcmV0dXJuIGN0eDtcbn1cblxuZnVuY3Rpb24gZ2V0UGl4ZWxEaXN0YW5jZShvbmUsIHR3bywgaSkge1xuICAgIHZhciByZGlmZiA9IG9uZS5kYXRhW2ldIC0gdHdvLmRhdGFbaV07XG4gICAgdmFyIGdkaWZmID0gb25lLmRhdGFbaSArIDFdIC0gdHdvLmRhdGFbaSArIDFdO1xuICAgIHZhciBiZGlmZiA9IG9uZS5kYXRhW2kgKyAyXSAtIHR3by5kYXRhW2kgKyAyXTtcblxuICAgIHZhciBkaXN0ID0gTWF0aC5mbG9vcihNYXRoLnNxcnQoTWF0aC5wb3cocmRpZmYsIDIpICsgTWF0aC5wb3coZ2RpZmYsIDIpICsgTWF0aC5wb3coYmRpZmYsIDIpKSk7XG4gICAgcmV0dXJuIGRpc3QgLyA0NDE7XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmUoY3VycmVudEZyYW1lLCBwcmV2aW91c0ZyYW1lKSB7XG4gICAgbGV0IGNoYW5nZWRJbmRleGVzID0gW11cbiAgICBsZXQgY3VycmVudEZyYW1lSW1hZ2VEYXRhID0gY3VycmVudEZyYW1lLmdldEltYWdlRGF0YSgwLCAwLCB4cGl4ZWxzLCB5cGl4ZWxzKTtcbiAgICBsZXQgbGFzdEZyYW1lSW1hZ2VEYXRhID0gcHJldmlvdXNGcmFtZS5nZXRJbWFnZURhdGEoMCwgMCwgeHBpeGVscywgeXBpeGVscyk7XG5cdCAgbGV0IHByb2Nlc3NlZEltYWdlRGF0YSA9IGN1cnJlbnRGcmFtZS5jcmVhdGVJbWFnZURhdGEoY3VycmVudEZyYW1lSW1hZ2VEYXRhKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3VycmVudEZyYW1lSW1hZ2VEYXRhLmRhdGEubGVuZ3RoOyBpICs9IDQpIHtcbiAgICAgICAgLy8gY2FudmFzIGltYWdlIGRhdGEgaXMgb3JkZXJlZCBcInIsIGcsIGIsIGFcIiBpbiBhIGNsYW1wZWQgYnl0ZSBhcnJheVxuICAgICAgICAvLyBwcm9jZXNzZWRJbWFnZURhdGEgPSBwcm9jZXNzZWRJbWFnZURhdGEuZGF0YVtpLCBpICsgM11cbiAgICAgICAgaWYgKGdldFBpeGVsRGlzdGFuY2UoY3VycmVudEZyYW1lSW1hZ2VEYXRhLCBsYXN0RnJhbWVJbWFnZURhdGEsIGkpID4gMC4yKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXggPSBpIC8gNDtcbiAgICAgICAgICAgIGNoYW5nZWRJbmRleGVzLnB1c2goaW5kZXgpO1xuXG4gICAgICAgICAgICBwcm9jZXNzZWRJbWFnZURhdGEuZGF0YVtpXSA9IDA7XG4gICAgICAgICAgICBwcm9jZXNzZWRJbWFnZURhdGEuZGF0YVtpICsgMV0gPSAwO1xuICAgICAgICAgICAgcHJvY2Vzc2VkSW1hZ2VEYXRhLmRhdGFbaSArIDJdID0gMDtcbiAgICAgICAgICAgIHByb2Nlc3NlZEltYWdlRGF0YS5kYXRhW2kgKyAzXSA9IDI1NTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb250ZXh0LnB1dEltYWdlRGF0YShwcm9jZXNzZWRJbWFnZURhdGEsIDAsIDApO1xuXG4gICAgbGV0IGNoYW5nZWR4eSA9IGNoYW5nZWRJbmRleGVzLm1hcChmdW5jdGlvbih4KXtcbiAgICAgICAgcmV0dXJuIGluZGV4VG9Db29yZGluYXRlcyh4LCB4cGl4ZWxzKTtcbiAgICB9KVxuXG4gICAgbGV0IGNoYW5nZXMgPSBjaGFuZ2VkeHkubGVuZ3RoO1xuICAgIGxldCBzdW14ID0gMDtcbiAgICBsZXQgc3VteSA9IDA7XG4gICAgLy8gbGV0XG4gICAgZm9yIChsZXQgcGl4ZWwgb2YgY2hhbmdlZHh5KSB7XG4gICAgICAgIHN1bXggKz0gcGl4ZWwueDtcbiAgICAgICAgc3VteSArPSBwaXhlbC55O1xuICAgIH1cbiAgICByZXR1cm4gW2NoYW5nZXMsIHN1bXgvY2hhbmdlcywgc3VteS9jaGFuZ2VzXTtcbiAgICBjb25zb2xlLmxvZyhjaGFuZ2UsIHN1bXgvY2hhbmdlcywgc3VteS9jaGFuZ2VzKTtcblxuICAgIC8vIGNvbnRleHQucHV0SW1hZ2VEYXRhKHByb2Nlc3NlZEltYWdlRGF0YSwgMCwgMCk7XG59XG5cbmZ1bmN0aW9uIGluZGV4VG9Db29yZGluYXRlcyhpbmRleCwgd2lkdGgpIHsgLy8gcmVtZW1iZXIgdGhhdCB0aGUgaW5kZXggaXMgciBnIGIgYSEhISBmaXggdGhpcyBmdW5jdGlvblxuICAgIHZhciB5ID0gTWF0aC5mbG9vcihpbmRleCAvIHdpZHRoKTtcbiAgICB2YXIgeCA9IGluZGV4IC0gKHkgKiB3aWR0aCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgeDogeCxcbiAgICAgICAgeTogeVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIFJhZGFyKCkge1xuICBsZXQgZnBzID0gMTY7XG4gIGxldCByYWRhciA9IG5ldyBPYmplY3QoKTtcbiAgLy8gbGV0IGNvbXBhcmVyID0gbmV3IEltYWdlQ29tcGFyZSgpO1xuICBsZXQgcHJldmlvdXNGcmFtZTtcblxuXG4gIHJhZGFyLnN0YXJ0ID0gKCkgPT4ge1xuICAgIHJhZGFyLnZpZGVvID0gZ2V0VmlkZW8oKTsgLy8gY2hhbmdlIHRvIHByb21pc2UgaW50ZXJmYWNlP1xuXG4gIH1cblxuICByYWRhci5zdGFydExvb3AgPSAoKSA9PiB7XG4gICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICBsb29wKCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBsb29wKCkgeyAvLyB3ZSBzaG91bGQgcGFzcyBpbiB0aW1lIGRpZmZlcmVuY2VzP1xuICAgIGxldCBjdXJyZW50RnJhbWUgPSBnZXRWaWRlb0ZyYW1lKHJhZGFyLnZpZGVvKTtcbiAgICBwcm9jZXNzKGN1cnJlbnRGcmFtZSwgcHJldmlvdXNGcmFtZSk7XG5cbiAgICBwcmV2aW91c0ZyYW1lID0gY3VycmVudEZyYW1lO1xuXG4gICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIGxvb3AoKTtcbiAgICAgIH0pXG4gICAgfSwgMTAwMCAvIGZwcyk7XG5cbiAgfVxuXG4gIGZ1bmN0aW9uIHByb2Nlc3MoY3VycmVudEZyYW1lLCBwcmV2aW91c0ZyYW1lKSB7XG4gICAgaWYgKHByZXZpb3VzRnJhbWUpIHtcbiAgICAgIGxldCB4eSA9IGNvbXBhcmUoY3VycmVudEZyYW1lLCBwcmV2aW91c0ZyYW1lLCB4cGl4ZWxzLCB5cGl4ZWxzKTtcblxuICAgICAgaWYgKHh5WzBdID4gNTApe1xuICAgICAgICAgIHBvc1swXSA9IHh5WzFdO1xuICAgICAgICAgIHBvc1sxXSA9IHh5WzJdO1xuICAgICAgICAvLyAgIHBvc1swXSA9IHh5WzFdIC8geXBpeGVsc1xuICAgICAgICAvLyAgIHBvc1sxXSA9IHh5WzJdIC8geHBpeGVsc1xuICAgICAgICB9XG4gICAgICAgIC8vIGNvbnRleHQucHV0SW1hZ2VEYXRhKHByb2Nlc3NlZEltYWdlRGF0YSwgcG9zWzBdLCBwb3NbMV0pO1xuICAgICAgICBjb25zb2xlLmxvZyhwb3MpO1xuICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9ICdyZWQnO1xuICAgICAgICBjb250ZXh0LmZpbGxSZWN0KHBvc1swXSwgcG9zWzFdLCAyMCwgMjApO1xuICAgIC8vICAgY29uc29sZS5sb2coeHkpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByYWRhcjtcbn1cblxuZnVuY3Rpb24gbWFpbigpIHtcbiAgbGV0IHIgPSBSYWRhcigpO1xuICByLnN0YXJ0KCk7XG5cbiAgd2luZG93LnNldFRpbWVvdXQoKCk9PntyLnN0YXJ0TG9vcCgpfSwgNTAwKTsgLy8gYWJzb2x1dGUgdHJhc2gsIHBsZWFzZSB1c2UgcHJvbWlzZXMgbmV4dCB0aW1lXG59XG5cbndpbmRvdy5vbmxvYWQgPSBtYWluO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
